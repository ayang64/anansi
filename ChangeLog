2005-04-11  Stephen Deasey  <sdeasey@users.sf.net>

	* tests/ns_urlencode.test: Add missing tests for urlencode fix.

2005-04-09  Stephen Deasey  <sdeasey@users.sf.net>

	* tests/ns_parseargs.test: Re-enable test for corrupted literal
	table.

2005-04-09  Zoran Vasiljevic  <vasiljevic@users.sf.net>

	* nsd/dns.c: Fixed GetAddr() when dealing with gethostbyname_r
	  calls. In some/many cases we ended up in an infinite loop.

	* nsd/tclobjv.c: SetSpecFromAny does not invalidate string rep 
	  of the passed object after converting it to the ns:spec
	  object type. This will definitely corrupt the interp literal
	  table and result in process exitus when the interp is being
	  destroyed.
	* nsd/tclobj.c: fixed broken ptr deref
	* nsd/nsmain.c: adjusted options parsing for Windows / unix

2005-04-08  Zoran Vasiljevic  <vasiljevic@users.sf.net>

	* nsd/nsd.h: Added non-gnu implementation of poll() for
	* nsd/unix.c: platforms not implementing it (Darwin)

2005-04-03  Vlad Seryakov  <seryakov@users.sf.net>

	* nsd.nsmain.c: fixed make test, argumens nowe processed
	  until first non dash parameter.

2005-04-03  Vlad Seryakov  <seryakov@users.sf.net>

	* nsd/nsmain.c: changed command line parsing from getopt to
	  simple manual processing thus getopt is not needed anymore.
	* nsd/getopt.c: removed because no needed anymore

2005-04-02  Stephen Deasey  <sdeasey@users.sf.net>

	* nsd/nsd.h:
	* nsd/driver.c:
	* nsd/tclinit.c:
	* nsd/nsmain.c: Add -c command line option which causes the server
	to start in command mode, reading commands from stdin and
	executing them like a tclsh.

	* Makefile:
	* tests/test.nscfg:
	* tests/all.tcl: Add new Makefile targets test, runtest and gdb
	which start the server in command mode.  Modify the test runner
	and add a test server config file.

	* tests/http.test:
	* tests/ns_addrbyhost.test:
	* tests/ns_adp_compress.test:
	* tests/ns_hostbyaddr.test:
	* tests/ns_hrefs.test:
	* tests/ns_parseargs.test: Update tests to use tlctest syntax and
	features.

2005-04-02  Vlad Seryakov  <seryakov@users.sf.net>

	* nsd/tclcmds.c: added synonyms for ns_uuencode/ns_uudecode procs
	  as ns_base64encode/ns_base64decode, because those functions actually
	  do base64 encoding
	* nsd/tclmisc.c:
	* nsd/uuencode.c: modified uuencode/decode to support
	  string buffers any size and be compatible with GNU uuencode,
	  i.e. wrapping lines to be 60 chars.

2005-03-28  Vlad Seryakov  <seryakov@users.sf.net>

	* nsd/nsd.h:
	* nsd/info.c:
	* nsd/op.c:
	* nsd/urlspace.c: Added support for ns_info filters, 
	  ns_info traces, ns_info requestprocs commands using new 
 	  Tcl callback interface. New commands show information about
	  registered filters/procs same way as ns_info scheduled does.

2005-03-27  Vlad Seryakov  <seryakov@users.sf.net>

	* nsd/tlrequest.c: In Ns_RegisterFilterObj command 'when'
	  was not initialized with 0 and because this is Ored flags
	  registered filters had incorrect mask.

2005-03-26  Stephen Deasey  <sdeasey@users.sf.net>

	* include/ns.h:
	* nsd/nsd.h:
	* nsd/proc.c:
	* nsd/tclrequest.c: Convert to new callback and parse proc APIs.
	Remove support for old connId parameter.

	* tcl/file.tcl:
	* tcl/util.tcl: Remove support for old connId parameter.
	
	* include/ns.h:
	* nsd/nsd.h:
	* nsd/Makefile:
	* nsd/tclcallbacks.c: Add routines to support calling Tcl code
	from C for callback events. (RFE #1162223)

	* nsd/proc.c:
	* nsd/tclcmds.c:
	* nsd/tclsched.c: Update to use new callback and parse proc APIs.
	
	* include/ns.h:
	* nsd/Makefile:
	* nsd/tclcmds.c:
	* nsd/cookies.c: Add cookie API for C and Tcl.  (RFE #1145957)

	* include/ns.h:
	* nsd/nsd.h:
	* nsd/tclobjv.c:
	* nsd/tclcmds.c:
	* tests/ns_parseargs.test: Change the signature of Ns_ObjvProc()s
	to return either TCL_OK, TCL_ERROR or TCL_BREAK.  Fixes a bug
	where options were being double-counted as args.  Also simplified
	the Ns_ObjvProc interface by passing the Ns_ObjvSpec directly.

	Added a new Tcl command: ns_parseargs specification args.  It
	parses options, args and handles defaults.

	* nsd/tclobj.c: Added some wrapper procs for handling Tcl obj
	types.

	* nsd/tclinit.c: Added Ns_TclPrintfResult() as a convenience for
	writing ints into a formatted string result.

2005-03-23  Vlad Seryakov <vlad@crystalballinc.com>

         include/ns.h:  Make Ns_SockBindUdp public function, it is public in
         nsd/binder.c already.

2005-03-22  Vlad Seryakov <vlad@crystalballinc.com>

         nsd/driver.c:  Ensure that socket driver's DriverClose callback 
         gets executed when the socket is released.  This was causing a 
         memory leak for HTTPS connections with nsopenssl when a Keep-Alive 
         HTTP request timed out. Closes SF Bug #1160850 from AOLServer.

2005-03-18  Zoran Vasiljevic  <vasiljevic@users.sf.net>

	* nsd/conn.c: Modified NsTclWriteContentObjCmd() to
	  consult reqPtr->avail instead of conn->contentLength
	  when examining how much bytes from the content is
	  still left to copy. The conn->contentLength is not
	  touched any more.

	* tcl/fastpath.tcl:
	* nsd/nsd.h:
	* nsd/return.c:
	* nsd/server.c: Removed handling of aolpress (RFE #1165562)

2005-03-17  Zoran Vasiljevic  <vasiljevic@users.sf.net>

	* nsd/conn.c: Added [ns_conn channel] (RFE #1156141)
	  Also, added [ns_conncptofp ?-bytes toCopy? channel]
	  (RFE #1156899). This change scraps parsing of the 
	  dummy connId argument left for 2.x server compat.

	* nsd/nsd.h
	* nsd/unix.h
	* nsd/nsmain.h: Added watchdog implementation (RFE #1156875)

2005-03-12  Vlad Seryakov <vlad@crystalballinc.com>

        * nspd/
        * nsext/: moved modules out of the core into modules /section

2005-03-08  Vlad Seryakov <vlad@crystalballinc.com>

	* nslog/nslog.c: as Stephan pointed there is possibility for 
	server to crash under some conditions accessing already freed 
	extheaders pointer. So i put lock before putting extheaders values 
        in the log, in most cases extheaders are empty so there is no overhead.

2005-03-07  Zoran Vasiljevic  <vasiljevic@users.sf.net>

	* nslog/nslog.c: fixed bad handling of rollfmt arg which
	caused segmetantion if the alternative rollfmt was not
	defined.

2005-03-07  Vlad Seryakov <vlad@crystalballinc.com>

        * include/hs.h:
        * nsd/conn.c: changed return status for Ns_ConnSetResponseStatus
        to void, corrected comments for this function.

2005-03-06  Vlad Seryakov <vlad@crystalballinc.com>

	* nsd/tclmisc.c:
	* nsd/tclcmds.c: added ns_sha1 command.

2005-03-06  Zoran Vasiljevic  <vasiljevic@users.sf.net>

	* nsd/tclxkeylist.c:
	* nsd/tclcmds.c: added objectified version of TclX keyed lists.

2005-03-05  Vlad Seryakov <vlad@crystalballinc.com>

	* nsd/conn.c include/ns.h Add Ns_ConnSetResponseStatus command to
        be able to se response status without touching headers. Also
        ns_conn status has been extended with ability to set response 
        status if third argument is provided. ns_conn status ?newStatus?

        * nslog/nslog.c: changed syntax to conform naviserver style,
        no functional modifications

2005-03-04  Stephen Deasey  <sdeasey@users.sf.net>

	* nsd/tclobjv.c: Add support for boolean options which take no
	argument. Truth is determined by presence of the option alone.

2005-03-01  Vlad Seryakov <vlad@crystalballinc.com>

	* nslog/nslog.c: redone options support for the module
        using flags, added commands to ns_accesslog to change flags and/or
        extended headers on the fly 

2005-02-27  Stephen Deasey  <sdeasey@users.sf.net>

	* nsd/tclobjv.c: Short circuit option processing when "--" is found.
	Accurately describe optional arguments as optional in error messages.

	* include/ns.h:
	* nsd/form.c:
	* nsd/request.c:
	* nsd/urlencode: Decode + and other characters in URL paths
	correctly.  Fixes bug #1145277.

	* nsd/mimetypes.c: XML mime types changed to application/xml from
	text/xml, fixes bug #1145927.  Added a handful of new mime
	mappings.

2005-02-26  Zoran Vasiljevic  <vasiljevic@users.sf.net>

	* nsd/tclobjv.c: New file with objv argument parsing code

	* nsd/Makefile: Added compliation directive for nsd/tclobjv.c

	* include/ns.h: Added declarations... 
 	 for following structs:
	    o. Ns_ObjvSpec
	    o. Ns_ObjvTable
	  and following calls:
	    o. Ns_ParseObjv
	    o. Ns_ObjvBool
	    o. Ns_ObjvInt
	    o. Ns_ObjvLong
	    o. Ns_ObjvWideInt
	    o. Ns_ObjvDouble
	    o. Ns_ObjvString
	    o. Ns_ObjvObj
	    o. Ns_ObjvIndex
	    o. Ns_ObjvFlags
	    o. Ns_ObjvBreak
	    o. Ns_ObjvArgs
	  This all implements new argument parsing code from Stephen.
 
2005-02-26  Zoran Vasiljevic  <vasiljevic@users.sf.net>

	* nsd/unix.c:
	* include/ns.h: added Ns_GetNameForUid(), Ns_GetNameForGid()
	
	* nsd/nsmain.c: allows server to be started as uid == 0
	  if both of the following are true:
	     o. the caller process is running as root (getuid() == 0)
	     o. "-u root" or "-u 0" was given on the command line
	  Also, improved and tightented verification of passed user
	  and/or group information.

2005-02-24  Vlad Seryakov <vlad@crystalballinc.com>

	* include/ns.h nsd/nsd.h nsd/binder.c: changed server name 
	  from AOLserver to NaviServer in ns_info command.
	  New ListenXXX family functions declared in the ns.h file. 

2005-02-22  Vlad Seryakov <vlad@crystalballinc.com>

	* nsd/tclsched.c nsd/tclcmds.c doc/at.n: added ns_atstartup
	  Tcl command to be run after server started and initialized. 
	  Update documentation about those commands, kind of.

2005-02-17  Zoran Vasiljevic <vasiljevic@users.sf.net>

	* nsd/tclfile.c: fixed broken NsTclChanObjCmd command which
	  caused server crashes when trasporting channels between 
	  threads when linked against Tcl 8.4+ library (Bug #1143586)

2005-02-16 Vlad Seryakov <vlad@crystalballinc.com>

	* Makefile configure configure.in sample-config.tcl 
	  include/Makefile.build include/Makefile.global.in 
	  include/Makefile.module.in include/ns.h include/nsdb.h 
	  include/nsextmsg.h include/nspd.h include/nsthread.h
	  tcl/charsets.tcl tcl/compat.tcl tcl/debug.tcl tcl/fastpath.tcl
	  tcl/file.tcl tcl/form.tcl tcl/http.tcl tcl/init.tcl
	  tcl/nsdb.tcl tcl/util.tcl: modified license in the header

	* tcl/sendmail.tcl: added erro notification flag to smtp_recv proc,
	  when receiving last QUIT response, do not fire exception if
	  remote server just drops the connection on QUIT

	* nsd/binder.c: added UDP/UNIX/RAW protocols to the sockets,

	* nsd/init.c: call InitLog before dns resolver will try to resolve 
	  local host, this prevents server crash

	* nsd/tclsock.c: back ported from CVS 4.1, added -localhost/-localport
	  to ns_scokopen

	* nsdb/dbdrv.c: if driver set exception in select, do to rewrite it 
	  in the server

2005-02-15  Zoran Vasiljevic <vasiljevic@users.sf.net>

	--- INITIAL IMPORT OF 4.0.10 AOLSERVER CODE ---
