<html>
<head>
<title>NaviServer</title>
</head>
<body>

<h1>NaviServer Maintenance Guide</h1>

<p>

<a href=#1>Command line parameters</a>

<p>

<a href=#2>NaviServer Maintenance</a>

<p>

<a href=#3>Maintain the NaviServer Directories</a>

<p>

<a href=#4>NaviServer Directory Map</a>

<p>

<a href=#5>NaviServer Security Guide</a>

<p>
<a href=#6>Recommended Security Modifications</a>

<p>

<h2><a name=1>NaviServer Command Line</a></h2>

<p>

bin/nsd [ -i | -f ] [-s servername] [ -d ] [ -k | -K ] [ -V ] [ -r root ] {-c | -t} config

Options:

<p>

<ul>

<li> <tt>-i</tt>

     <p>

     Run NaviServer from /etc/inittab. This option is similar to -f except
     that stdout goes to the server.log file.

<li> <tt>-f</tt>

     <p>

     Run NaviServer in the foreground.

<li> <tt>-s servername</tt>

     <p>

     Specify the server to run, if the configuration file defines multiple
     servers. The Server1 server will be run by default.

<li> <tt>-d</tt>

     <p>

     Run NaviServer in the debugger (ignore SIGINT).

<li> <tt>-k</tt>

     <p>

     Kill the running NaviServer (based on pidfile) and continue.

<li> <tt>-K</tt>

     <p>

     Kill the running NaviServer (based on pidfile) and terminate.

<li> <tt>-V</tt>

     <p>

     Print the version number of NaviServer.

<li> <tt>-r root</tt>

     <p>

     Perform chroot to a new root directory.

<li> <tt>{-c|-t} config</tt>

     <p>

     Required. Specify -c if the configuration file is in the .ini format
     from previous NaviServer versions or -t if the configuration file is in
     .tcl format. Specify the path to the configuration file.
</ul>

<p>

 <h3>Examples</h3>

<p>

<tt>nsd -t nsd.tcl</tt>

<p>

This is the simplest form of the command line.

<p>

<tt>nsd -ft nsd.tcl</tt>

<p>

NaviServer will be run in the foreground.

<p>

<tt>nsd -fkt nsd.tcl -r /newroot</tt>

<p>

NaviServer will be run in a chroot environment, and any
currently-running server will be killed.

<p>

<h2><a name=2>NaviServer Maintenance</a></h2>

<p>

An NaviServer installation requires regular maintenance as follows:

<p>

<ol>

<li> Make regular backups of pages and associated files for each
     virtual server.

<p>

<li> Make regular backups of the access log.

<p>

<li> Make regular backups of the server log, especially if verbose
     messages are enabled.

<p>

<li> Make regular backups of the Tcl directory(ies).

<p>

<li> Make regular backups of the bin directory, especially if you have
     customized loadable modules.

</ul>

<p>

Each of these maintenance tasks is described in the following sections.

<p>

<h2><a name=3>Maintain the NaviServer Directories</a></h2>

<p>

The NaviServer directories described below should be backed up
regularly to ensure against file system failure.

<p>

 <h3>Back Up the Pages Directory</h3>

<p>

The location of the pages directory for each virtual server is
determined by the server-specific PageDir entry in the NaviServer
configuration file. Normally, it is the /pages subdirectory under
the NaviServer home directory.

<p>

Use whatever file system backup procedure you have in place at your
site. To schedule nightly backups, use the Unix cron facility.

<p>

 <h3>Back Up the Access Log</h3>

<p>

The access log file needs to be backed up regularly. By default, the
access log for each virtual server is in the
/logs/access.log file under the NaviServer home directory.

<p>

The access log can be configured to limit the number of old logs
maintained (with the MaxBackup parameter). This sets an upper limit on
the amount of disk space the access logs take. However, because old
logs beyond the limit configured to be saved by the NaviServer are
deleted automatically, you must back up old logs if you require a
complete history of access to your site. For example, if the MaxBackup
parameter in the configuration file is set to 5, only five old access
log files will remain on disk. When a sixth log file needs to be
opened, the oldest log is removed.

<p>

 <h3>Back Up the Server Log</h3>

<p>

Ordinarily, the server log file grows at a slow rate and does not need
regular truncation. However, while debugging new applications, you
should set the Verbose parameter in the ns/module/nsdb/pool/pool-name
section in the configuration file to on instead of off (the
default). Every SQL statement sent to the database is logged in the
error log and causes the file to grow much more quickly. In this case
you may want to back up the error log.

<p>

 <h3>Back Up the Tcl Scripts Directory</h3>

<p>

The Tcl scripts directory contains the source to the Tcl scripts that
provide the server with much of its advanced functionality. Tcl
scripts for each virtual server are stored in the
/tcl subdirectory by default, and global Tcl scripts are
stored in the /modules/tcl subdirectory by default.

<p>

If you write new Tcl scripts or edit the existing ones, you must
ensure your changes are saved regularly to a safe place. Also, be sure
that any external files utilized by your Tcl scripts are backed up
too, including files outside the NaviServer home directory.

<p>

 <h3>Back Up the bin Directory</h3>

<p>

The /bin subdirectory of the NaviServer home is the location of the
NaviServer binary and the default location of any dynamically loadable
C modules. If your site maintains several interesting loadable
modules, you must make sure copies of the modules are backed up to
avoid having to recompile them after a file system failure. Also, be
sure to back up your module source code.


<p>

<h2><a name=4>Directory Map</a></h2>

<p>

This table describes all of the directories that are created under the
NaviServer installation directory when you install NaviServer. It lists
the files or types of files that are stored in each directory, the
configuration parameters that affect the directory or the files in the
directory, and references to where you can find more information on
the associated NaviServer features.

<p>

<tt>/bin</tt>

<p>

Directory containing the NaviServer binary and the default directory
for any dynamically-loadable C modules.

<p>

Files:

<p>

 .so files
 nsd
 translate-ini

<p>

<tt>/include</tt>

<p>

Directory containing header files for NaviServer.

<p>

Files:

<p>

 .h files

<p>

<tt>/lib</tt>

<p>

Directory containing static libraries used for building customized
components to NaviServer. This directory currently only includes the
libnspd.a file that can be used to build database proxy daemons
(external database drivers).

<p>

Files:

<p>

 libnsd.so
 libnsdb.so
 libnsthread.so
 libnsproxy.so

<p>

<tt>/logs</tt>

<p>

Directory containing log files and the server pid file.

<p>

Files:

<p>

 access.log
 server.log
 nsd.pid

<p>

<tt>/modules</tt>

<p>

Contains directories for each configured module that operates across
servers, such as the tcl module.

<p>

<tt>/modules/nscp</tt>

<p>

Directory containing files related to control port interface.

<p>

Files:

<p>

 tcsh.inputrc

<p>


<tt>/tcl</tt>

<p>

Default directory for shared Tcl script library. Also contains
subdirectories containing Tcl examples and Tcl scripts for various
modules.

<p>

Files:

<p>

 .tcl files

<p>

<tt>/modules/nsperm</tt>

<p>

Directory containing user, group, and permissions files which is used to provide access control
for NaviServer.

<p>

Files:

<p>

 passwd file
 group file
 hosts.allow file
 hosts.deny file
 perms file

<p>

<tt>/modules/tcl</tt>

<p>

Default directory for private Tcl script library for this server.

<p>

Files:

<p>

 .tcl files

<p>


<tt>/pages</tt>

<p>

Default directory where pages and graphics for the server are stored.
Users can optionally have individual subdirectories of this directory
(see UserDir, below).

<p>

Files:

<p>

 typically, .htm, .html, .shtml, and .adp files

<p>

<h1><a name=5>NaviServer Security Guide</a></h1>

This chapter provides guidelines for ensuring the security of systems
running NaviServer. It describes the issues that must be considered and
the associated modifications that should be made to NaviServer
installations.

<p>

 <h3>General nsadmin Passwords</h3>

<p>

By default, the nsadmin password for NaviServer is either set to NULL
or to a poor password. Set an acceptable password for nsadmin as
described below.

<p>

Edit the nsadmin entry in the /modules/nsperm/passwd file. For
example, the default passwd file contains this nsadmin entry:
 nsadmin:CUdnvgBYocLSI:::::

<p>

Substitute an alternate encrypted password in place of CUdnvgBYocLSI.

<p>

To encrypt a password, you can copy an already-encrypted password from
the /etc/passwd file or run the bin/nspasswd utility. It will prompt
you for a password and return the encrypted version of the password.

<p>

For more information about the passwd file, see the "Defining Users"
section.

<p>

 <h3>Permission Settings</h3>

<p>

It is more secure to avoid using the nsperm module and use file-level
security for ADPs. If you must use the nsperm module, set appropriate
permissions records as follows:

<p>

<ol>

<li> Maintain the same permission records for GET and POST; they
     actually provide the same permissions.

<p>

<li> Remove any permission records related to network publishing (PUT,
     DELETE, MKDIR, and BROWSE) for all users except nsadmin.

<p>

<li> Keep in mind the inheritance rules for permission records. In
     general, a permission record for a directory also applies to the
     directories underneath it.
</ul>

<p>

To define NaviServer permissions, create permission entries for them in
the perms file, which resides in the /modules/nsperm directory. The
default perms file does not contain any permission entries, but it
contains comments that explain how to add entries to the file.

<p>

For more information about setting permissions, see the "Permissions"
section.

<p>

<h2><a name=6>Recommended Security Modifications</a></h2>

<p>

The actions described in this section are recommended, but not
required, to ensure the security of systems running NaviServer.

<p>

 <h3>NaviServer Version</h3>

<p>

In general, NaviServer versions 4.99 and higher should be used whenever
possible, because they are more secure than earlier versions of
NaviServer.

<p>

<ul>

<li> NaviServer can be run in a chroot environment.

<p>

<li> The configuration file, which has a new Tcl format, is executed in
     a separate, temporary interpreter that is destroyed before startup
     begins. The configuration file memory buffer is then zeroed after
     parsing.

<p>

<li> The nsd binary can be stored outside the root directory because
     NaviServer no longer locates and re-executes itself.

<p>

<li> The configuration file can be stored outside the root directory,
     because NaviServer opens and reads the configuration file before
     running chroot().

<p>

<li> The nscp module, which allows connections only from localhost,
     provides a secure control port interface that allows ad hoc Tcl
     evaluation and other server administration features. For more
     information about the control port interface, see the "NaviServer's
     Control Port Interface" section.
</ul>

<p>

 <h3>Secure chroot Environment</h3>

<p>

NaviServer should be run in a secure chroot() environment whenever
possible.

<p>

In Versions 4.99 or higher, NaviServer supports a -r command line option
to run NaviServer in a chroot() environment. It provides the following
benefits:

<p>

<ul>

<li> The chroot() system call updates the process such that all
     absolute filenames are relative to a new root directory instead of
     the actual mounted file system.

<p>

<li> The chroot() call is irrevocable. Once chroot() returns, the
     server cannot access any file above the new root directory.

<p>

<li> Although it does not actually protect any of the underlying
     content, scripts, or protected databases, chroot() is the single
     most effective tool for protecting the server machine and
     sensitive information, such as user passwords and configuration
     files, from view.
</ul>

<p>

To run NaviServer in a chroot() environment, you need only copy a few
files and directories to the new root directory. For example, on the
SGI platform, you would execute the following commands to create new
directories and copy the necessary files to them:

<p>

mkdir $root/dev $root/tmp $root/etc

<p>

chmod 1777 $root/tmp

<p>

cd $root/dev; /dev/MAKEDEV generic usema

<p>

cp /etc/passwd /etc/resolve.conf $root/etc

<p>

Then, you can run NaviServer with the -r option as in this example:
 nsd -t nsd.tcl -r $root

<p>

For more information about the nsd command line, see the "NaviServer
Command Line" section.

<p>

 <h3>Restricted Content</h3>

<p>

Determine whether any of the content available to an NaviServer in a
chroot() environment would be restricted. In general, NaviServer should
be read-only and everything it can read should be world-readable. This
allows the NaviServer administrator to ignore the nsperm module
altogether.

<p>

If any of the content available to NaviServer is restricted, the
NaviServer administrator needs to define the appropriate permissions
with the nsperm module. The administrator should be very clear which
areas are blocked off and know both the URL and METHOD for the
restricted areas.

<p>

It is preferable to allow the GET method for all URLs and have nothing
restricted accessible through NaviServer.

<p>

 <h3>Tcl Library</h3>

<p>

Limit the available Tcl functions to just those functions that are
necessary by that particular NaviServer installation. Purge the Tcl
library of unnecessary functions. For example, if the site doesn't
send e-mail, remove the ns_sendmail procedures.

<p>

Some potentially unsafe commands you may want to consider removing
are:

<p>

<ul>

<li> File system related functions, such as open, read, and puts

<p>

<li> The NaviServer ns_sock* Tcl functions

<p>

<li> The Tcl socket routines

<p>

<li> The exec command

<p>

<li> The file command, or at least the delete and rename features

<p>

<li> The exit command

</ul>

<p>

This code example disables the open command:

<p>

<pre>
static int
AddCmds(Tcl_Interp, void *arg) {
    Tcl_CreateCommand(interp, "open", BadCmd, NULL, NULL);
    return TCL_OK;
}

static int
BadCmd(ClientData dummy, Tcl_Interp *interp, int argc, char **argv) {
    Tcl_AppendResult(interp, "disabled command: ", argv[0], NULL);
    return TCL_ERROR;
}

</pre>

<p>

 <h3>Database Access</h3>

<p>

Database access should be restricted with read-only logins to the
server and queries through stored procedures.

<p>

For more information about the Tcl functions for stored procedures,
see the "ns_db" section of the NaviServer Tcl Developer's Guide. For
more information about the C functions for stored procedures, see the
"Stored Procedure Functions" section of the NaviServer C Developer's
Guide.

<p>

 <h3>Control Port Interface</h3>

<p>

The control port interface should not be used unless absolutely
necessary. Although it is more secure than the /NS/Admin interface
from earlier NaviServer versions because it only allows connections
from localhost, it still poses a risk potential.

<p>

For more information about the control port interface, see the
"NaviServer's Control Port Interface" section.


<p>

</body>
</html>
