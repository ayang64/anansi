<html>
<head>
<title>NaviServer</title>
</head>
<body>

<h1>NaviServer Tcl Overview</h1>

<a href=#1>What is Tcl?</a>

<p>

<a href=#2>Why Use Tcl?</a>

<p>

<a href=#3>ADPs and Tcl Libraries</a>

<p>

<a href=#4>Tcl Interpreters</a>

<p>

<a href=#5>Global Variables</a>

<p>

<a href=#6>Sharing Files Between Interpreters</a>

<p>

<a href=#7>Working with Ns_Set and Form Data</a>

<p>

This chapter contains general information about using Tcl whether you
are using the ADP approach or the Tcl Libraries approach, both of
which use the same features of Tcl.

<p>


<h2><a name=1>What is Tcl?</a></h2>

<p>

Tcl is a programming system developed by John Ousterhout at the
University of California, Berkeley. According to Dr. Ousterhout:

<p>

<blockquote>
<i>
Tcl is a simple scripting language for controlling and extending
applications; its name stands for "tool command language". Tcl
provides generic programming facilities, such as variables and loops
and procedures, that are useful in a variety of applications.
Furthermore, Tcl is embedable. Its interpreter is a library of C
procedures that can easily be incorporated into applications, and each
application can extend the core Tcl features with additional commands
for that application.
</i>
</blockquote>


<p>

NaviServer supports the Tcl v7.6 commands. When you write NaviServer
extensions in Tcl, you use the core functionality of Tcl as well as a
set of NaviServer-specific Tcl functions. For example, there is an
NaviServer Tcl function called ns_conn that allows your Tcl script to
obtain information about the current connection. In addition,
functions are available for returning results to Web clients,
accessing databases, and managing the permissions (access control)
system.

<p>

This book describes the two different methods for extending NaviServer
with Tcl, using NaviServer Dynamic Pages (Chapter 2) and Tcl libraries
(see Chapter 3), plus general information on using Tcl with either
method (see Chapter 4). It also provides a reference for NaviServer's
Tcl API (see Chapter 5).

<p>

 Recommended Reading

<p>

For more information on the Tcl language, we recommend the following
sources:
<p>
  * Practical Programming in Tcl and Tk, by Brent B. Welch (Prentice
 Hall PTR, 1995)
<p>
  * Tcl and the Tk Toolkit, by John K. Ousterhout (Addison-Wesley,
 1994)
<p>
  * For the complete manual pages for the Tcl v7.6 commands, visit the
 web site http://www.scriptics.com/man.
<p>
  * Philip Greenspun's web site,
 http://www-swiss.ai.mit.edu/wtr/dead-trees/, which includes
 chapters from his book, Database Backed Web Sites, The Thinking
 Person's Guide to Web Publishing, and numerous examples of
 NaviServer Tcl database applications.
<p>
  * The web site:
 http://www.yahoo.com/Computers_and_Internet/Programming_Languages/
 Tcl_Tk

<p>

<h2><a name=2>Why Use Tcl?</a></h2>

<p>

You can extend NaviServer using Tcl, C, or CGI. However, using Tcl has
the following advantages:
<p>
  * Creating new Tcl scripts is very easy. You can embed Tcl scripts
 directly into HTML pages using NaviServer Dynamic Pages (ADPs), or
 you can create .tcl files and register them to handle URLs or URL
 hierarchies.
<p>
  * Tcl's scripting language is easier to learn and use than compiled
 programming languages. It provides general programming
 capabilities, such as variables, loops, and procedures, but it
 doesn't require strong type definitions or compilation. Plus,
 NaviServer's Tcl interface provides a complete set of Tcl
 extensions specifically oriented towards web server applications,
 such as returning content to the client, accessing form data,
 accessing databases, and logging.
<p>
  * Many of the basic NaviServer services are implemented as Tcl
 scripts. In fact, most of the database operations such as handling
 database inserts, queries, and updates, are written as Tcl
 scripts. Not only has the Tcl interface greatly reduced the
 development time for the NaviServer engineering team, it also
 allows you to easily modify the basic database operations by
 simply editing the Tcl scripts that implement the functionality.
<p>
  * The Tcl and C interfaces typically provide better performance than
 CGI. However, if you have existing CGI programs, you may want to
 use NaviServer's CGI interfaces to take advantage of
 previously-existing code.

<p>

The C interface for NaviServer is described in the NaviServer C
Developer's Guide, and the CGI interface is desribed in the NaviServer
Administrator's Guide.

<p>



<h2><a name=3>ADPs and Tcl Libraries</a></h2>

<p>

There are two ways to extend NaviServer using Tcl, and each is
better-suited to different situations:
<p>
  * NaviServer Dynamic Pages (ADPs): ADPs allow you to embed Tcl
 scripts directly into HTML pages. The script(s) are interpreted
 dynamically when the page is accessed. ADPs are ideal in
 situations where you want to generate all or part of a specific
 page dynamically. You can re-use code by storing Tcl scripts in
 Tcl libraries and invoking them from within multiple ADPs. You can
 also include files and parse other ADPs from within your ADPs.

<p>

  * Tcl Libraries: The alternative to embedding Tcl scripts in HTML
 pages using ADPs, is to store Tcl scripts in Tcl libraries. You
 can define scripts that can be called from ADPs, schedule
 procedures to run at certain times, register scripts to handle
 specific URLs or URL hierarchies, register scripts to handle all
 URLs with a specific file extension, and register filters to be
 run in addition to a URL's registered procedure.

<p>

<h2><a name=4>Tcl Interpreters</a></h2>

<p>

   During NaviServer initialization, only one interpreter exists. While
   modules are loaded and initialized, they may add procedures to the
   interpreter. When initialization is complete (all modules are loaded
   and all Tcl libraries have been executed), the interpreter may no
   longer be changed.

<p>

   Each connection thread that requires Tcl will create a copy of the
   original interpreter.

<p>

   The AutoClose parameter, which is on by default, will close all
   non-shared files opened by an interpreter when Ns_TclDeAllocateInterp
   is invoked. Ns_TclDeAllocateInterp is called after each Tcl request
   procedure. It is recommended that you leave the AutoClose parameter
   set to on.

<p>

<h2><a name=5>Global Variables</a></h2>

<p>

   In earlier releases of the NaviServer, global variables were shared
   between all Tcl interpreters in a virtual server. Beginning in Version
   2.2, each Tcl interpreter has its own global variable table, so global
   variables are shared only within each Tcl interpreter by default. The
   ns_share command allows you to make a variable available to all
   interpreters in a virtual server.

<p>

   Global variables are flushed when the Tcl interpreter is deallocated.
   A Tcl interpreter is deallocated explicitly when
   Ns_TclDeallocateInterp is called or implicitly at the end of a
   connection. This allows Tcl filter functions to access global
   variables set in ADPs.

<p>

   

<h2><a name=6>Sharing Files Between Interpreters</a></h2>

<p>

   To share a file between the interpreters in a group, use the Tcl
   detach command. A shared file is left open after an interpreter is
   deallocated when the AutoClose parameter is on (it is on by default).
<br>
   For example:
<br>
    #init time:
<br>
    set sharedFile [open myfile.dat]
<br>
    detach $sharedFile
<br>

<p>

   You must manually close the shared file (by performing a close) when
   it is no longer needed or when the server is shut down.

<p>

   Note that there is no implicit locking between interpreters. This
   means that one interpreter can be performing a gets command on the
   shared file at the same time another interpreter performs a close on
   the same file. The results are unpredictable, and could potentially
   cause a core dump. To avoid this situation, use a mutex to protect
   access to the file whenever it is accessed.

<p>

   For example:, at initialization time (for example, in your init.tcl
   script), open a shared file and create a mutex:
<br>
    set sharedLock [ns_mutex create]
<br>
    set sharedFile [open myfile.dat]
<br>
    detach $sharedFile
<br>

<p>

   At run time, use the mutex to protect any actions you perform on the
   shared file:
<br>
    ns_share sharedLock
<br>
    ns_share sharedFile
<br>
    ns_mutex lock $sharedLock
<br>
    puts $sharedFile ...
<br>
    gets $sharedFile ...
<br>
    ns_mutex unlock $sharedLock
<br>

<p>

   At shutdown (for example, in your shutdown procedure registered with
   ns_atshutdown), close the file and destroy the lock:
<br>
    ns_share sharedLock
<br>
    ns_share sharedFile
<br>
    close $SharedFile
<br>
    ns_mutex destroy $SharedLock
<br>


<p>

<h2><a name=7>Working with Ns_Set and Form Data</a></h2>

<p>

   An NaviServer operation procedure often manipulates sets of key-value
   pairs of string data, for example:

<p>

<br>
          rows of data from the database
<br>
          HTTP header information
<br>
          HTML form data
<br>

<p>

    Ns_Set Data Structure

<p>

   In the NaviServer C API these data are manipulated using the Ns_Set
   data structure. In the Tcl API the ns_set command can be used to
   manipulate underlying Ns_Set data structures that are generated by the
   NaviServer communications layer or the database services module.

<p>

   The example below shows a typical use of the ns_set Tcl command to
   manipulate Ns_Set structures.
<pre>
   # Example 2: Show header data
    #
    # Things to notice:
    # * The same function is registered for two different URLs
    # with different context.
    #
    # * The headers are pulled out of the conn using the
    # ns_conn function.
    #
    # * The value for a particular header line is extracted
    # with "ns_set get".

    ns_register_proc GET /example/showbrowser \
        showheader USER-AGENT
    ns_register_proc GET /example/showrefer \
        showheader REFER

    proc showheader {conn key} {
          set value [ns_set get [ns_conn headers $conn] $key]
          ns_return $conn 200 text/plain "$key: $value"
    }
</pre>

<p>

    Form Data

<p>

   Some Database Services Tcl functions take formdata arguments. You can
   get the form data for a form by calling ns_conn form. An ns_set
   structure containing key/value pairs is returned, which you can
   manipulate using the ns_set function. The key/value pairs for search,
   entry, and update forms are provided below.

<p>

   Search Form Data

<p>

         Key

<p>

   Value

<p>

   ColSelected.columnname

<p>

   "on" or "off"

<p>

   ColOperator.columnname

<p>

   search operator

<p>

   (=, &lt;, &gt;, &lt;=, &gt;=, is null, is not null)

<p>

   ColValue.columnname

<p>

   search value for text, integer, real, or boolean fields

<p>

   ColValue.columnname.NULL

<p>

   "t" or "f" (true or false), indicates whether to search for the
   specified date, time, or timestamp field

<p>

   ColValue.columnname.month

<p>

   month portion of search value for date and timestamp fields

<p>

   ColValue.columnname.day

<p>

   day portion of search value for date and timestamp fields

<p>

   ColValue.columnname.year

<p>

   year portion of search value for date and timestamp fields

<p>

   ColValue.columnname.time

<p>

   time portion of search value for time and timestamp fields

<p>

   ColValue.columnname.ampm

<p>

   "AM" or "PM" designation of search value for time and timestamp fields

<p>

   OrderBy.n

<p>

   name of column to order the results by (where n is 0 for the first
   order by column, 1 for the second order by column, and so on)

<p>

   Queryinfo.Distinct

<p>

   "on" or "off", indicates whether query should eliminate duplicate
   records

<p>

   Pref.MaxToReturn

<p>

   integer, maximum number of records to return

<p>

   Entry Form Data

<p>

         Key

<p>

   Value

<p>

   ColValue.columnname

<p>

   value for text, integer, real, or boolean fields

<p>

   ColValue.columnname.NULL

<p>

   "t" or "f" (true or false), indicates whether a date, time, or
   timestamp field is null or the value specified in the date/time
   portions

<p>

   ColValue.columnname.month

<p>

   month portion of value for date and timestamp fields

<p>

   ColValue.columnname.day

<p>

   day portion of value for date and timestamp fields

<p>

   ColValue.columnname.year

<p>

   year portion of value for date and timestamp fields

<p>

   ColValue.columnname.time

<p>

   time portion of value for time and timestamp fields

<p>

   ColValue.columnname.ampm

<p>

   "AM" or "PM" designation of value for time and timestamp fields

<p>

   Update/Delete Form Data

<p>

             Key

<p>

   Value

<p>

   ColValue.columnname

<p>

   value for text, integer, real, or boolean fields

<p>

   ColValue.columnname.NULL

<p>

   "t" or "f" (true or false), indicates whether a date, time, or
   timestamp field is null or the value specified in the date/time
   portions

<p>

   ColValue.columnname.month

<p>

   month portion of value for date and timestamp fields

<p>

   ColValue.columnname.day

<p>

   day portion of value for date and timestamp fields

<p>

   ColValue.columnname.year

<p>

   year portion of value for date and timestamp fields

<p>

   ColValue.columnname.time

<p>

   time portion of value for time and timestamp fields

<p>

   ColValue.columnname.ampm

<p>

   "AM" or "PM" designation of value for time and timestamp fields

<p>

   RowID.columnname

<p>

   all the RowID values that specify the row to update or delete

<p>


<p>

</body>
</html>
